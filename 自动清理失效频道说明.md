# 自动清理失效频道/群组功能

## 功能说明

脚本现在会自动检测并处理已失效的 Telegram 频道/群组/Bot。

### 什么会被删除？

当 Telegram API 返回以下错误时，条目会被标记为"不存在"：
- `chat not found` - 频道未找到
- `not found` - 不存在
- `deleted` - 已删除
- `deactivated` - 已停用
- `blocked` - 已封禁

---

## 配置选项

### 在脚本顶部配置

```python
# ============ 清理配置 ============
# 是否自动删除不存在的频道/群组
AUTO_DELETE_NOT_FOUND = True  # True=自动删除，False=仅标记不删除
DELETED_ITEMS_FILE = "deleted_items.json"  # 保存已删除条目的备份
```

### 两种模式

#### 模式1：自动删除（推荐）
```python
AUTO_DELETE_NOT_FOUND = True
```
- ✅ 自动从 `data.json` 中删除不存在的条目
- ✅ 保持数据文件干净整洁
- ✅ 所有删除的条目都会备份到 `deleted_items.json`
- ✅ 可以随时恢复误删的数据

#### 模式2：仅标记
```python
AUTO_DELETE_NOT_FOUND = False
```
- ⚠️ 不删除条目，仅在描述前添加 `[已失效]` 标记
- 适用于：想要保留历史记录，手动审核后再删除

---

## 运行示例

### 模式1：自动删除

```
[15/2000] 处理: @deleted_channel - 某个频道
  ⏱️  已用: 0.5分钟 | 剩余: 4.5分钟
  ❌ 频道/群组不存在或已删除: @deleted_channel
  🗑️  已标记为删除（频道不存在）

...

🗑️  正在删除 23 个不存在的条目...
  从 Telegram工具 > 搜索机器人 删除了 5 个条目
  从 群组频道 > 社群 删除了 12 个条目
  从 机场VPN > 翻墙 删除了 6 个条目
  💾 已删除条目已备份到: deleted_items.json

💾 data.json 已更新

============================================================
📊 处理统计：
  ✅ 成功获取: 1800 个
  ⏭️  跳过: 150 个
  ❌ 失败: 27 个
  🗑️  已删除: 23 个（频道不存在）
  📁 共更新: 1800 个头像
  ⏱️  总耗时: 5.2 分钟
  📁 头像保存在: telegram_avatars/ 目录
  📦 已删除条目备份: deleted_items.json

💡 下一步：
   1. 将 telegram_avatars 文件夹上传到你的服务器
   2. 或使用图床服务获取在线URL
   3. 已自动删除 23 个不存在的频道/群组
   4. 如需恢复，请查看: deleted_items.json
============================================================
```

### 模式2：仅标记

```
[15/2000] 处理: @deleted_channel - 某个频道
  ⏱️  已用: 0.5分钟 | 剩余: 4.5分钟
  ❌ 频道/群组不存在或已删除: @deleted_channel
  ⚠️  已标记为失效（不删除）
```

---

## 备份文件格式

### deleted_items.json

所有被删除的条目都会保存到这个文件中，格式如下：

```json
[
  {
    "title": "某个频道",
    "url": "https://t.me/deleted_channel",
    "description": "这是一个已删除的频道",
    "logo": "",
    "username": "deleted_channel",
    "reason": "not_found",
    "deleted_at": "2025-11-04 15:30:45"
  },
  {
    "title": "另一个失效群组",
    "url": "https://t.me/another_group",
    "description": "这个群组已失效",
    "logo": "",
    "username": "another_group",
    "reason": "not_found",
    "deleted_at": "2025-11-04 15:31:20"
  }
]
```

### 字段说明

- `title`: 频道/群组名称
- `url`: 原始链接
- `description`: 描述信息
- `logo`: 原有的logo路径
- `username`: Telegram用户名
- `reason`: 删除原因（`not_found`）
- `deleted_at`: 删除时间戳

---

## 如何恢复误删的数据？

### 方法1：从备份恢复

1. 打开 `deleted_items.json`
2. 找到误删的条目
3. 复制条目内容
4. 粘贴回 `data.json` 的相应位置
5. 删除多余字段（`username`, `reason`, `deleted_at`）

### 方法2：从Git恢复（如果使用版本控制）

```bash
# 查看修改
git diff data.json

# 恢复整个文件
git checkout data.json

# 或恢复特定版本
git checkout HEAD~1 data.json
```

---

## 使用建议

### 首次运行

建议先使用"仅标记"模式，检查哪些频道被标记为失效：

```python
AUTO_DELETE_NOT_FOUND = False  # 仅标记，不删除
```

运行后，检查标记为 `[已失效]` 的条目，确认无误后：

```python
AUTO_DELETE_NOT_FOUND = True  # 改为自动删除
```

再次运行，清理失效条目。

### 定期清理

建议每月运行一次脚本，清理失效的频道/群组：

```bash
# 1. 确保.env文件配置正确
# 2. 运行脚本
python fetch_telegram_avatars.py

# 3. 检查备份文件
cat deleted_items.json

# 4. 上传更新后的data.json到服务器
```

---

## 安全保障

### 1. 备份机制
- ✅ 所有删除的条目都会备份
- ✅ 备份文件包含完整的原始数据
- ✅ 记录删除时间，便于追溯

### 2. 断点续传
- ✅ 即使中途中断，已处理的数据会保存
- ✅ 再次运行时跳过已处理的条目

### 3. 错误容忍
- ✅ 网络错误不会导致误删
- ✅ 只有明确的"不存在"错误才会删除
- ✅ 其他错误类型会保留条目

---

## 常见问题

### Q1: 如果是临时网络问题导致的"不存在"错误怎么办？

**A**: 脚本有重试机制，会重试3次。只有持续返回"不存在"错误才会删除。

### Q2: 如果频道只是暂时私有化，会被误删吗？

**A**: 私有频道通常返回不同的错误码，不会被删除。只有明确的"chat not found"才会删除。

### Q3: 备份文件会越来越大吗？

**A**: 是的。建议定期清理 `deleted_items.json`，或将其归档。

### Q4: 可以只删除特定分类的失效条目吗？

**A**: 当前不支持。但可以手动修改脚本，添加分类过滤。

---

## 技术细节

### 检测逻辑

```python
# 检查是否为频道不存在的错误
not_found_keywords = [
    'chat not found',  # 频道未找到
    'not found',       # 不存在
    'deleted',         # 已删除
    'deactivated',     # 已停用
    'blocked'          # 已封禁
]

is_not_found = any(keyword in error_description.lower() 
                   for keyword in not_found_keywords)
```

### 删除流程

1. 检测到"不存在"错误
2. 备份条目到 `deleted_items` 列表
3. 标记为待删除 (`items_to_delete`)
4. 继续处理其他条目
5. 处理完成后，批量删除
6. 保存备份到 `deleted_items.json`
7. 更新 `data.json`

---

## 文件结构

```
tg_html/
├── fetch_telegram_avatars.py  # 主脚本
├── data.json                  # 数据文件（会被更新）
├── deleted_items.json         # 删除备份（自动生成）
├── fetch_progress.json        # 进度文件（自动生成）
├── telegram_avatars/          # 头像目录（自动生成）
└── .env                       # 配置文件（需手动创建）
```

---

## 总结

### 优点
- ✅ 自动清理失效频道，保持数据库干净
- ✅ 完整备份，防止误删
- ✅ 灵活配置，支持两种模式
- ✅ 安全可靠，有重试和容错机制

### 注意事项
- ⚠️ 首次运行建议使用"仅标记"模式
- ⚠️ 定期备份 `data.json`
- ⚠️ 查看 `deleted_items.json` 确认删除是否正确

---

**生成时间**: 2025-11-04  
**版本**: v2.0

